#### Mysql 体系结构

![img](https://pic2.zhimg.com/80/v2-4ce9c07e160c6c3e48387bc98d5295e1_1440w.jpg)

逻辑系统架构分为3层

- 应用层
- MySQL服务层
- 存储引擎层

**MySQL 应用层（Connection Pool）**

- 连接处理

  客户端向服务端发送连接请求后，MySQL server会从线程池中分配一个线程来和客户端进行连接，以后该客户端的请求都会被分配到该线程上，提供了线程池，减少了创建线程和释放线程所花费的时间

- 用户鉴权

  MySQL鉴权依据是: 用户名，客户端主机地址和用户密码

- 安全管理

  根据用户的权限来判断用户具体可执行哪些操作

**MySQL 服务层**

- MySQL Management Server & utilities
  - 数据库备份和恢复
  - 数据库安全管理，如用户及权限管理
  - 数据库复制管理
  - 数据库集群管理
  - 数据库分区，分库，分表管理
  - 数据库元数据管理

- SQL Interface(SQL 接口)

  - Data Manipulation Language (DML).
  - Data Definition Language (DDL).
  - 存储过程
  - 视图
  - 触发器

- SQL Parser(SQL 解析器)

  解析查询语句，最终生成语法树，语法有错误，则返回相应的错误信息；检查通过后解析器会查询缓存，缓存中有对应的语句，直接返回结果

- Optimizer(查询优化器)

  对查询语句进行优化，包括选择合适的索引，数据的读取方式

- Caches & buffers(缓存)

  全局和引擎特定的缓存，提高查询的效率，由一系列小缓存组成，如表缓存、记录缓存、key缓存、权限缓存等

**存储引擎层**

- **存储引擎**

  插件式的表存储引擎、ySQL AB公司提供的文件访问层抽象接口来定制一种文件访问的机制

  - 如何选择存储引擎

    - Innodb：数据一致性高，需要事务的支持
    - myisam：查询多更新少，对查询性能要求比较高
    - memory：临时表
    - 自定义实现存储引擎

  - Innodb 操作流程

    ![image-20200826143709102](C:\Users\Admin\AppData\Roaming\Typora\typora-user-images\image-20200826143709102.png)

  - 缓冲池 Buffer Pool

    Innodb 的数据都是放在磁盘上，最小的逻辑单位页（索引页和数据页），使用缓冲池来完成

    - 读取：如果在就直接读取
    - 修改：修改缓冲池里边的页，数据不一致形成脏页，有专门的后台线程每隔一段时间负责写入磁盘
    - redolog ：将对缓存池的修改操作写入文件，数据库启动的时候会进行恢复、实现事务持久化

  - 需要的数据随机分散在不同的扇区，随机IO；假设找到第一块数据，其他就在这一块的后边，叫做顺序IO；刷盘是随机IO；记录日志是顺序IO

- 物理文件

  redolog、undolog、binlog、errorlog、querylog、slowlog、data、index等

#### 索引

##### 为什么要建立索引

一个排序的数据结构、快速查询、更新数据文件，减少磁盘IO

##### 索引类型

- 普通索引（索引列包含重复值）

- 唯一索引（避免出现数据重复）

- 主键索引

  - 一种约束
  - 一张表一个主键、多个唯一索引
  - 主键创建后一定包含一个唯一索引、唯一索引并不一定是主键
  - 主键不能为null，唯一索引可以为null

- 全文索引

  比较大的数据

- 复合索引

  覆盖多个数据列

##### **索引使用原则**

- 列的离散度
- 联合索引最佳左匹配

**索引优劣势**

- 保证数据唯一性、提高检索效率、加速表连接、减少分组排序的时间
- 耗费时间、占用物理空间，降低表的维护速度

##### 索引结构

- 二分查找

  适合静态数据

- 二叉查找树

  - 若左子树不空，则左子树上所有节点的值均小于它的根节点的值
  - 若右子树不空，则右子树上所有节点的值均大于它的根节点的值
  - 它的左、右子树也分别为二叉排序数（递归定义）

  查找是比较方便的，因为每次经过一次节点时，最多可以减少一半的可能，极端情况会出现所有节点都位于同一侧，直观上看就是一条直线；需要对二叉树左右子树的高度进行平衡化处理

- 平衡二叉树
  - 左右深度差不能超过1
  - 会导致树的深度很高、数据量越大、深度越高

- B树 （多路平衡查找树）

  - 关键字集合分布在整颗树中，分叉树永远比关键字多1
  - 任何一个关键字出现且只出现在一个节点中
  - 搜索有可能在非叶子节点结束
  - 其搜索性能等价于在关键字集合内做一次二分查找
  - B树在插入删除新的数据记录会破坏B-Tree的性质，因为在插入删除时，需要对树进行一个分裂、合并、转移等操作以保持B-Tree性质

  B-树的搜索，从根结点开始，对结点内的关键字（有序）序列进行二分查找，如果命中则结束，否则进入查询关键字所属范围的儿子结点；重复，直到所对应的儿子指针为空，或已经是叶子结点

  每一个内部节点会包含一定数量的键值。通常，键值的数量被选定在d和2d之间

- B+树
  - 所有关键字都存储在叶子节上，且链表中的关键字恰好是有序的
  - 关键字的数量和线路数相等
  - 非叶子节点相当于叶子节点的索引，叶子节点相当于是存储（关键字）数据的数据层
  - 更适合文件索引系统
  - 每个叶子结点增加了一个指向相邻叶子结点的指针，最后一个数指向下一个叶子结点的第一个数据，形成了有序链表

##### mysql的两种存储引擎的索引存储机制

- MyISAM  叶节点的data域存放的是数据记录的地址

  - MyISAM中索引检索的算法为首先按照B+Tree搜索算法搜索索引，如果指定的Key存在，则取出其data域的值，然后以data域的值为地址，读取相应数据记录，**非聚集索引**

- InnoDB

  - InnoDB的数据文件本身就是索引文件
  - 表数据文件本身就是按B+Tree组织的一个索引结构，这棵树的叶节点data域保存了完整的数据记录，InnoDB表数据文件本身就是主索引，**聚集索引**

  

